音声入力支援Webアプリケーション 要件定義書 (v4)

1. システムアーキテクチャ

構成: Docker Compose で管理されるコンテナ構成。

Frontend: React (SPA)

Backend: Python (FastAPI/Flask等)

Database: PostgreSQL (検索機能・拡張性を考慮)

Storage: ローカルファイルシステム (音声ファイル・テキストファイルの永続化)

2. データ管理と永続化

2.1. ファイル保存構造

セッション（履歴の1単位）ごとにフォルダを作成し、物理ファイルを保存する。

/data
  /{session_id}  <-- UUIDなどで一意に識別
    /audio
      - block_1.m4a
      - block_2.m4a
    /text
      - recognition.json (認識結果リスト)
      - result.md (エディター内容)


2.2. データベースと同期

自動保存: フロントエンドの操作（認識結果修正、エディタ編集）は即座にPostgreSQLへ保存される。

ファイル同期: 「実行ボタン押下時」や「明示的な保存時」、あるいはバックグラウンドジョブにより、DBの内容を物理ファイル（JSON/MD）へ書き出す。

2.3. バックアップ・アーカイブ・移行 (New)

データのポータビリティと容量管理のため、エクスポート・インポート・一括削除機能を提供する。

2.3.1. エクスポート機能

指定条件: 期間指定（From - To）。

出力形式: 1つの tar.gz ファイル。

出力モード: 容量と用途に応じて内容を選択可能にする。

フルバックアップ: DBデータ(JSONダンプ) + 音声ファイル + ユーザー設定。

テキスト・メタデータのみ: DBデータ + ユーザー設定。（音声ファイル除外。軽量で検索・閲覧用）

音声ファイルのみ: 指定期間の音声ファイルのみ。（後から結合するため）

設定のみ: ユーザー設定ファイル (prompts.json 等) のみ。

2.3.2. インポート機能

重複制御: session_id をキーとして重複チェックを行う。

新規: DBおよびファイルシステムに追加。

既存 (テキストのみ): 音声ファイルが含まれるアーカイブをインポートした場合、既存のセッションフォルダに音声ファイルを追加配置し、リンクさせる（「あとから音声追加」に対応）。

設定インポート: ユーザー設定を上書きまたはマージするオプションを用意。

2.3.3. 期間指定削除 (アーカイブ運用)

機能: 指定した期間のセッションデータ（DBレコードおよび物理ファイル）を一括削除する。

用途: 「1年分をエクスポートして退避した後、システムから削除して軽量化する」運用をサポート。

安全策: 削除前に該当件数を表示し、確認ダイアログを経由する。

3. 設定管理 (Configuration)

設定は「システム設定（変更不可）」と「ユーザー設定（変更可能）」に分離する。

3.1. システム設定 (config.yaml)

Backend側で読み込み、FrontendにはReadOnlyで渡す。

API接続情報:

音声認識API (URL, AuthType, Key/Token)

文章生成API (URL, AuthType, Key/Token)

AuthType: API-Key Header または Bearer Token を指定可能。

初期設定: デフォルト言語、保存エンコード（UTF-8推奨）、改行コード（LF推奨）。

3.2. ユーザー設定 (prompts.json / user_settings.json)

Frontendから編集・保存可能。

エクスポート/インポート対象: バックアップに含まれる。

プロンプトテンプレート: タイトルと本文（複数行）のペア。

表示設定: テーマ、エディタのフォントサイズなど。

辞書データ: 音声認識補正用の単語リスト。

4. 画面レイアウト詳細

4.1. 左ペイン：履歴

基本機能はv1同様。

削除時は物理フォルダごと削除するAPIをコールする。

4.2. 中央ペイン：認識結果リスト

各ブロックはDB上のレコードと紐づく。

4.3. 右ペイン：エディター

タブ切り替え: 「編集 (Markdown/Text)」と「プレビュー」のタブを設ける。

モード切替: Markdownとしてのプレビュー機能に加え、Plain Textとして表示するモードもサポート。

4.4. フッターエリア (コントローラー)

プロンプト入力欄:

音声入力ボタン: 押している間（またはトグルで）音声を認識し、テキストボックスの末尾に追記する。この音声データは保存しない。

実行ボタン: 選択範囲とプロンプトに基づきLLM処理を実行。

4.5. 設定モーダル

タブ構成:

一般 (General): 言語設定、エンコード、改行コード。

API (System): システム設定の表示。

プロンプト (Templates): テンプレート管理。

単語登録 (Vocab): 辞書管理。

データ管理 (Data Management): (New)

エクスポート: 期間指定カレンダー、対象チェックボックス（テキスト/音声/設定）、実行ボタン。

インポート: ファイル選択、実行ボタン。

データ削除: 期間指定カレンダー、削除実行ボタン。

操作:

保存ボタン: 設定を保存するがモーダルは閉じない。

閉じるボタン: モーダルを閉じる。

5. テキスト処理仕様

文字コード: 基本 UTF-8。

改行コード: 基本 LF (\n)。設定で変更可。